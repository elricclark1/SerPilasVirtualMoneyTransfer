name: Android Build

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    # Run the job inside the standard Kivy Buildozer container
    container:
      image: ghcr.io/kivy/buildozer:latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Fix Permissions
        # GitHub Actions runs as root in the container, but checkout might have different perms.
        # We ensure the workspace is writable.
        run: |
          chown -R root:root $GITHUB_WORKSPACE
          git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Install Dependencies
        # The container has most things, but sometimes we need specific libs for Python packages
        run: |
          apt-get update
          apt-get install -y libffi-dev libssl-dev zip

      - name: Build with Buildozer
        run: |
          # Ensure .buildozer directory exists
          mkdir -p .buildozer
          
          # Force yes to accept license and install dependencies
          yes | buildozer android debug
        env:
          # Fix for "dirty" git versioning if .git exists but permissions are weird
          P4A_RELEASE_Keystore: ${{ secrets.P4A_RELEASE_KEYSTORE }} 
          P4A_RELEASE_KEYSTORE_PASSWD: ${{ secrets.P4A_RELEASE_KEYSTORE_PASSWD }}
          P4A_RELEASE_KEYALIAS_PASSWD: ${{ secrets.P4A_RELEASE_KEYALIAS_PASSWD }}
          P4A_RELEASE_KEYALIAS: ${{ secrets.P4A_RELEASE_KEYALIAS }}
          # Run as root inside the container
          BUILDOZER_WARN_ON_ROOT: 0

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: serpilas-debug
          path: bin/*.apk

      - name: Release APK
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: bin/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate QR Code Summary
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          # Use Python to find the file because ls output can be tricky in scripts
          apk_path=$(ls bin/*.apk | head -n 1)
          apk_name=$(basename "$apk_path")
          
          download_url="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/$apk_name"
          
          # Encode URL
          encoded_url=$(echo "$download_url" | sed 's/:/%3A/g; s/\//%2F/g')
          qr_url="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=$download_url"
          
          echo "### ðŸ“± Android Download (Pieron)" >> $GITHUB_STEP_SUMMARY
          echo "Scan to install version **${{ github.ref_name }}**:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[![QR Code]($qr_url)]($download_url)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Direct Link: [Download APK]($download_url)" >> $GITHUB_STEP_SUMMARY